# 後端系統並發架構說明

## 系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                    Node.js 事件循環 (單線程)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ HTTP API    │  │ WebSocket   │  │ 背景任務     │              │
│  │ 服務器      │  │ 即時通信    │  │ 監控        │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                   │
│         ▼                 ▼                 ▼                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ REST API    │  │ 價格推送    │  │ 套利監控    │              │
│  │ 端點        │  │ 100ms       │  │ 1000ms      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                   │
│         ▼                 ▼                 ▼                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                事件隊列 (非阻塞)                             │ │
│  │  • HTTP 請求處理                                            │ │
│  │  • WebSocket 消息處理                                       │ │
│  │  • 定時器回調                                               │ │
│  │  • 異步 I/O 回調                                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    外部服務                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Bybit API   │  │ WebSocket   │  │ 前端客戶端  │              │
│  │ REST        │  │ 連接        │  │ React App   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 並發處理機制

### 1. 事件循環處理順序

```
1. 處理 HTTP 請求 (非阻塞)
   ├── GET /api/status
   ├── POST /api/monitoring/pairs
   ├── GET /api/monitoring/prices
   └── POST /api/arbitrage/execute

2. 處理 WebSocket 事件 (非阻塞)
   ├── 新連接建立
   ├── 價格數據推送
   ├── 訂單簿更新
   └── 持倉變化

3. 處理定時器回調 (非阻塞)
   ├── 套利機會檢查 (1000ms)
   ├── TWAP 策略執行
   ├── 健康檢查
   └── 日誌清理

4. 處理異步 I/O (非阻塞)
   ├── Bybit API 調用
   ├── 文件讀寫
   ├── 數據庫操作
   └── 網絡請求
```

### 2. 關鍵技術特點

#### A. 非阻塞 I/O
```javascript
// 同時處理多個請求，不會互相阻塞
app.get('/api/status', async (req, res) => {
    // 這個請求處理時，其他請求可以同時進行
    const status = await getSystemStatus();
    res.json(status);
});
```

#### B. 事件驅動
```javascript
// 使用事件來協調不同組件
engine.on('opportunitiesFound', (opportunities) => {
    // 當發現套利機會時，觸發相應處理
    handleArbitrageOpportunities(opportunities);
});
```

#### C. 異步並行處理
```javascript
// 同時執行多個操作
const [leg1Result, leg2Result] = await Promise.all([
    bybitService.placeOrder(leg1Order),
    bybitService.placeOrder(leg2Order)
]);
```

#### D. 內存快取
```javascript
// 快取最新價格數據，避免重複 API 調用
this.tickerCache.set(symbol, {
    bid1: { price: bidPrice, amount: bidSize },
    ask1: { price: askPrice, amount: askSize }
});
```

## 性能優勢

1. **高並發**: 單線程事件循環可以處理數千個並發連接
2. **低延遲**: WebSocket 推送延遲 < 100ms
3. **高效率**: 非阻塞 I/O 最大化 CPU 利用率
4. **實時性**: 價格監控和套利執行幾乎即時
5. **可擴展**: 可以輕鬆添加新的監控對和策略

## 系統監控

系統同時運行多個監控任務：

- **價格監控**: 每秒檢查所有監控對的價差
- **套利機會**: 實時檢測符合條件的套利機會
- **TWAP 策略**: 定時執行時間加權平均價格策略
- **風險控制**: 持續監控交易風險和限制
- **系統健康**: 定期檢查服務狀態和連接

這種架構確保了系統能夠同時維持穩定的服務運行，並高效執行各種交易相關任務。
